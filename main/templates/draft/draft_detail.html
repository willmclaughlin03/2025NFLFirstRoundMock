<!DOCTYPE html>
{% load custom_tags %}

<html>

<head>
    <title>NFL Draft Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding: 20px;
            background-color: #f8f9fa;
        }
        .draft-container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            padding: 20px;
            margin-top: 20px;
        }
        .player-card {
            transition: all 0.3s;
            cursor: pointer;
        }
        .player-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .selected {
            border: 3px solid #28a745;
            background-color: #f8fff9;
        }
        .draft-pick {
            border-left: 4px solid #007bff;
        }
        .completed-pick {
            background-color: #e8f4ff;
        }
        .current-pick {
            background-color: #fff3cd;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { background-color: #fff3cd; }
            50% { background-color: #ffe8a1; }
            100% { background-color: #fff3cd; }
        }
        .pick-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #28a745;
            color: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
            animation: fadeInOut 4s ease-in-out;
        }
        @keyframes fadeInOut {
            0% { opacity: 0; }
            10% { opacity: 1; }
            80% { opacity: 1; }
            100% { opacity: 0; }
        }
        .team-on-clock {
            font-weight: bold;
            font-size: 1.2em;
            color: #dc3545;
            margin-bottom: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #dc3545;
        }
        .team-logo {
            height: 30px;
            margin-right: 10px;
            vertical-align: middle;
        }
        .last-pick {
            margin-top: 15px;
            padding: 10px;
            background-color: #e8f4ff;
            border-radius: 5px;
            border-left: 4px solid #007bff;
        }
        .pagination-container {
            display: flex;
            justify-content: center;
            margin-top: 15px;
        }
        .page-indicator {
            margin: 0 10px;
            line-height: 38px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4">NFL Draft Manager</h1>
        
        <!-- Pick notification popup -->
        <div class="pick-notification" id="pick-notification">
            <strong>Pick Made!</strong>
            <p id="pick-notification-text"></p>
        </div>
        
        <div class="row">
            <!-- Draft Board Column -->
            <div class="col-md-8">
                <div class="draft-container">
                    <h3>Draft Board</h3>
                    <button class="btn btn-primary mb-3" id="start-draft-btn">Start Draft</button>
                    
                    <!-- Team on clock display -->
                    <div class="team-on-clock" id="team-on-clock">
                        {% if not draft.is_completed %}
                            <span id="team-on-clock-text">
                                <strong>On The Clock:</strong> {{ current_team }}
                                <span class="badge bg-danger">Pick #{{ current_pick }}</span>
                            </span>
                        {% else %}
                            <span>Draft Completed</span>
                        {% endif %}
                    </div>
                    
                    <!-- Last pick display -->
                    <div class="last-pick" id="last-pick" style="display: none;">
                        <strong>Last Pick:</strong>
                        <span id="last-pick-text">No picks yet</span>
                    </div>
                    
                    <div class="alert alert-info" id="draft-status">
                        {% if draft.is_completed %}
                            <strong>Draft Completed!</strong>
                        {% else %}
                            <p><strong>Current Pick:</strong> {{ current_pick }} - {{ current_team }}</p>
                            {% with team_needs|dict_get:current_team as current_needs %}
                                {% if current_needs %}
                                    <p><strong>{{ current_team }} Needs:</strong> {{ current_needs|join:", " }}</p>
                                {% else %}
                                    <p><strong>{{ current_team }} Needs:</strong> Not available</p>
                                {% endif %}
                            {% endwith %}
                        {% endif %}
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="thead-dark">
                                <tr>
                                    <th>Pick</th>
                                    <th>Team</th>
                                    <th>Player</th>
                                    <th>Position</th>
                                    <th>College</th>
                                </tr>
                            </thead>
                            <tbody id="draft-picks">
                                {% for pick in draft_picks %}
                                <tr class="{% if pick.pick_number == current_pick and not draft.is_completed %}current-pick{% elif pick.player %}completed-pick{% endif %}" id="pick-row-{{ pick.pick_number }}">
                                    <td>{{ pick.pick_number }}</td>
                                    <td>{{ pick.team_name }}</td>
                                    <td>
                                        {% if pick.player %}
                                            {{ pick.player.first_name }} {{ pick.player.last_name }}
                                        {% else %}
                                            <em>Pending selection</em>
                                        {% endif %}
                                    </td>
                                    <td>{{ pick.player.position|default:"" }}</td>
                                    <td>{{ pick.player.college|default:"" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Player Selection Column -->
            <div class="col-md-4">
                <div class="draft-container">
                    <h3>Available Players</h3>
                    <div class="mb-3">
                        <input type="text" class="form-control" id="player-search" placeholder="Search players...">
                    </div>
                    <div class="list-group" id="player-list">
                        {% for player in available_players %}
                        <a href="#" class="list-group-item list-group-item-action player-card" 
                           data-player-id="{{ player.id }}"
                           data-page="1"
                           onclick="selectPlayer(this, {{ player.id }}, {{ current_pick }})">
                            <div class="d-flex w-100 justify-content-between">
                                <h5 class="mb-1">{{ player.first_name }} {{ player.last_name }}</h5>
                                <small class="text-muted">#{{ player.draft_ranking }}</small>
                            </div>
                            <p class="mb-1">
                                <span class="badge bg-primary">{{ player.position }}</span>
                                {{ player.college }}
                            </p>
                            <small class="text-muted">Age: {{ player.age }}</small>
                            <button class="btn btn-outline-primary btn-sm float-end" 
                                    onclick="selectPlayer(this.parentElement, {{ player.id }}, {{ current_pick }})">Select Player</button>
                        </a>
                        {% empty %}
                        <div class="alert alert-warning">No players available</div>
                        {% endfor %}
                    </div>
                    
                    <!-- Pagination Controls -->
                    <div class="pagination-container">
                        <button class="btn btn-outline-secondary" id="prev-page" disabled>&laquo; Previous</button>
                        <span class="page-indicator" id="page-indicator">Page 1</span>
                        <button class="btn btn-outline-secondary" id="next-page">Next &raquo;</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal fade" id="confirmPickModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Draft Pick</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>You are about to select <strong id="selected-player-name"></strong> for <strong id="selected-team-name">{{ current_team }}</strong> with pick #<strong id="selected-pick-number">{{ current_pick }}</strong>.</p>
                    <p>Are you sure?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirm-pick-btn">Confirm Pick</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let selectedPlayerId = null;
        let selectedPickNumber = {% if current_pick %}{{ current_pick }}{% else %}1{% endif %};
        let isDraftStarted = {% if draft.id %}true{% else %}false{% endif %};
        let draftId = {% if draft.id %}{{ draft.id }}{% else %}null{% endif %};
        let currentTeam = "{{ current_team }}";
        let teamOrder = [
            {% for pick in draft_picks %}
                "{{ pick.team_name }}"{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];

        // Pagination variables
        let currentPage = 1;
        let playersPerPage = 10;
        let totalPlayers = document.querySelectorAll('.player-card').length;
        let totalPages = Math.ceil(totalPlayers / playersPerPage);
        
        // Initialize pagination
        function initPagination() {
            document.getElementById('page-indicator').textContent = `Page ${currentPage} of ${totalPages}`;
            document.getElementById('prev-page').disabled = (currentPage === 1);
            document.getElementById('next-page').disabled = (currentPage === totalPages || totalPages === 0);
            
            // Show only players for current page
            const allPlayers = document.querySelectorAll('.player-card');
            const startIndex = (currentPage - 1) * playersPerPage;
            const endIndex = startIndex + playersPerPage;
            
            allPlayers.forEach((player, index) => {
                if (index >= startIndex && index < endIndex) {
                    player.style.display = 'block';
                } else {
                    player.style.display = 'none';
                }
            });
        }
        
        // Pagination event listeners
        document.getElementById('prev-page').addEventListener('click', function() {
            if (currentPage > 1) {
                currentPage--;
                initPagination();
            }
        });
        
        document.getElementById('next-page').addEventListener('click', function() {
            if (currentPage < totalPages) {
                currentPage++;
                initPagination();
            }
        });
        
        // Start draft function
        document.getElementById('start-draft-btn').addEventListener('click', async function(e) {
            e.preventDefault();
            try {
                const response = await fetch("{% url 'draft-create' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    isDraftStarted = true;
                    draftId = data.id;
                    window.location.href = `/drafts/${data.id}/`;
                } else {
                    alert('Error starting draft: ' + data.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while starting the draft');
            }
        });
        
        // Player selection function
        function selectPlayer(element, playerId, pickNumber) {
            if (!isDraftStarted) {
                alert('Please start the draft first!');
                return;
            }
            
            // Remove selected class from all players
            document.querySelectorAll('.player-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Add selected class to clicked player
            element.classList.add('selected');
            selectedPlayerId = playerId;
            selectedPickNumber = pickNumber;
            
            // Update modal with player info
            const playerName = element.querySelector('h5').textContent;
            document.getElementById('selected-player-name').textContent = playerName;
            document.getElementById('selected-team-name').textContent = currentTeam;
            document.getElementById('selected-pick-number').textContent = pickNumber;
            
            // Show confirmation modal
            const modal = new bootstrap.Modal(document.getElementById('confirmPickModal'));
            modal.show();
        }
        
        // Confirm pick function
        document.getElementById('confirm-pick-btn').addEventListener('click', async function() {
            const modal = bootstrap.Modal.getInstance(document.getElementById('confirmPickModal'));
            modal.hide();
            
            if (!draftId) {
                alert('Error: No draft ID available');
                return;
            }
            
            // Show loading indicator or disable buttons if needed
            document.getElementById('confirm-pick-btn').disabled = true;
            
            try {
                const response = await fetch(`/api/drafts/${draftId}/add_pick/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        player_id: selectedPlayerId,
                        pick_number: selectedPickNumber,
                        round_number: 1
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Show a brief success message
                    const playerName = document.getElementById('selected-player-name').textContent;
                    const pickNotification = document.getElementById('pick-notification');
                    const pickNotificationText = document.getElementById('pick-notification-text');
                    
                    pickNotificationText.textContent = `${currentTeam} selects ${playerName} with pick #${selectedPickNumber}`;
                    pickNotification.style.display = 'block';
                    
                    // Reload the page after a short delay to show the notification
                    setTimeout(() => {
                        if (data.status === 'draft completed') {
                            window.location.href = `/drafts/${draftId}/results/`;
                        } else {
                            // Reload the current page to refresh everything
                            window.location.href = `/drafts/${draftId}/`;
                        }
                    }, 1500);
                } else {
                    document.getElementById('confirm-pick-btn').disabled = false;
                    alert('Error: ' + (data.message || 'Failed to add pick'));
                }
            } catch (error) {
                document.getElementById('confirm-pick-btn').disabled = false;
                console.error('Error:', error);
                alert('An error occurred while making the pick');
            }
        });
        
        // Player search functionality
        document.getElementById('player-search').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            let visiblePlayers = 0;
            
            document.querySelectorAll('.player-card').forEach(card => {
                const playerText = card.textContent.toLowerCase();
                const doesMatch = playerText.includes(searchTerm);
                
                if (doesMatch) {
                    visiblePlayers++;
                }
                
                // Reset pagination when searching
                if (searchTerm) {
                    card.style.display = doesMatch ? 'block' : 'none';
                    document.getElementById('prev-page').style.display = 'none';
                    document.getElementById('next-page').style.display = 'none';
                    document.getElementById('page-indicator').textContent = 
                        visiblePlayers > 0 ? `Showing ${visiblePlayers} results` : 'No matching players';
                } else {
                    // Return to normal pagination
                    document.getElementById('prev-page').style.display = 'block';
                    document.getElementById('next-page').style.display = 'block';
                    initPagination();
                }
            });
        });
        
        // Initialize the view with any existing picks
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize pagination
            initPagination();
            
            const lastCompletedPickRows = document.querySelectorAll('.completed-pick');
            if (lastCompletedPickRows.length > 0) {
                // Get the last completed pick
                const lastRow = lastCompletedPickRows[lastCompletedPickRows.length - 1];
                const pickNumber = lastRow.querySelector('td:nth-child(1)').textContent;
                const team = lastRow.querySelector('td:nth-child(2)').textContent;
                const player = lastRow.querySelector('td:nth-child(3)').textContent;
                
                // Update last pick display
                const lastPickElement = document.getElementById('last-pick');
                const lastPickText = document.getElementById('last-pick-text');
                lastPickText.textContent = `${team} selected ${player} with pick #${pickNumber}`;
                lastPickElement.style.display = 'block';
            }
        });
    </script>
</body>
</html>