<!DOCTYPE html>
<html>
<head>
    <title>NFL Draft Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding: 20px;
            background-color: #f8f9fa;
        }
        .draft-container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            padding: 20px;
            margin-top: 20px;
        }
        .player-card {
            transition: all 0.3s;
            cursor: pointer;
        }
        .player-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .selected {
            border: 3px solid #28a745;
            background-color: #f8fff9;
        }
        .draft-pick {
            border-left: 4px solid #007bff;
        }
        .completed-pick {
            background-color: #e8f4ff;
        }
        .current-pick {
            background-color: #fff3cd;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { background-color: #fff3cd; }
            50% { background-color: #ffe8a1; }
            100% { background-color: #fff3cd; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4">NFL Draft Manager</h1>
        
        <div class="row">
            <!-- Draft Board Column -->
            <div class="col-md-8">
                <div class="draft-container">
                    <h3>Draft Board</h3>
                    <button class="btn btn-primary mb-3" id="start-draft-btn">Start Draft</button>
                    <div class="alert alert-info" id="draft-status">
                        {% if draft.is_completed %}
                            Draft Completed!
                        {% else %}
                            Current Pick: {{ current_pick }} - {{ current_team }}
                        {% endif %}
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="thead-dark">
                                <tr>
                                    <th>Pick</th>
                                    <th>Team</th>
                                    <th>Player</th>
                                    <th>Position</th>
                                    <th>College</th>
                                </tr>
                            </thead>
                            <tbody id="draft-picks">
                                {% for pick in draft_picks %}
                                <tr class="{% if pick.pick_number == current_pick and not draft.is_completed %}current-pick{% elif pick.player %}completed-pick{% endif %}">
                                    <td>{{ pick.pick_number }}</td>
                                    <td>{{ pick.team_name }}</td>
                                    <td>
                                        {% if pick.player %}
                                            {{ pick.player.first_name }} {{ pick.player.last_name }}
                                        {% else %}
                                            <em>Pending selection</em>
                                        {% endif %}
                                    </td>
                                    <td>{{ pick.player.position|default:"" }}</td>
                                    <td>{{ pick.player.college|default:"" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Player Selection Column -->
            <div class="col-md-4">
                <div class="draft-container">
                    <h3>Available Players</h3>
                    <div class="mb-3">
                        <input type="text" class="form-control" id="player-search" placeholder="Search players...">
                    </div>
                    <div class="list-group" id="player-list">
                        {% for player in available_players %}
                        <a href="#" class="list-group-item list-group-item-action player-card" 
                           data-player-id="{{ player.id }}"
                           onclick="selectPlayer(this, {{ player.id }}, {{ current_pick }})">
                            <div class="d-flex w-100 justify-content-between">
                                <h5 class="mb-1">{{ player.first_name }} {{ player.last_name }}</h5>
                                <small class="text-muted">#{{ player.draft_ranking }}</small>
                            </div>
                            <p class="mb-1">
                                <span class="badge bg-primary">{{ player.position }}</span>
                                {{ player.college }}
                            </p>
                            <small class="text-muted">Age: {{ player.age }}</small>
                            <button` class="btn btn-outline-primary btn-sm float-end" 
                                    onclick="selectPlayer(this.parentElement, {{ player.id }}, {{ current_pick }})">Select Player</button>
                        </a>
                        {% empty %}
                        <div class="alert alert-warning">No players available</div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal fade" id="confirmPickModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Draft Pick</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>You are about to select <strong id="selected-player-name"></strong> for <strong id="selected-team-name">{{ current_team }}</strong> with pick #<strong id="selected-pick-number">{{ current_pick }}</strong>.</p>
                    <p>Are you sure?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirm-pick-btn">Confirm Pick</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let selectedPlayerId = null;
        let selectedPickNumber = {% if current_pick %}{{ current_pick }}{% else %}1{% endif %};
        let isDraftStarted = {% if draft.id %}true{% else %}false{% endif %};
        let draftId = {% if draft.id %}{{ draft.id }}{% else %}null{% endif %};
        
        // Start draft function
        document.getElementById('start-draft-btn').addEventListener('click', async function(e) {
            e.preventDefault();
            try {
                const response = await fetch("{% url 'draft-create' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    isDraftStarted = true;
                    draftId = data.id;
                    window.location.href = `/drafts/${data.id}/`;
                } else {
                    alert('Error starting draft: ' + data.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while starting the draft');
            }
        });
        
        // Player selection function
        function selectPlayer(element, playerId, pickNumber) {
            if (!isDraftStarted) {
                alert('Please start the draft first!');
                return;
            }
            
            // Remove selected class from all players
            document.querySelectorAll('.player-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Add selected class to clicked player
            element.classList.add('selected');
            selectedPlayerId = playerId;
            selectedPickNumber = pickNumber;
            
            // Update modal with player info
            const playerName = element.querySelector('h5').textContent;
            document.getElementById('selected-player-name').textContent = playerName;
            
            // Show confirmation modal
            const modal = new bootstrap.Modal(document.getElementById('confirmPickModal'));
            modal.show();
        }
        
        // Confirm pick function
        document.getElementById('confirm-pick-btn').addEventListener('click', async function() {
            const modal = bootstrap.Modal.getInstance(document.getElementById('confirmPickModal'));
            modal.hide();
            
            if (!draftId) {
                alert('Error: No draft ID available');
                return;
            }
            
            try {
                const response = await fetch(`/api/drafts/${draftId}/add_pick/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        player_id: selectedPlayerId,
                        pick_number: selectedPickNumber,
                        round_number: 1
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Remove selected player from the board
                    const selectedCard = document.querySelector(`[data-player-id="${selectedPlayerId}"]`);
                    if (selectedCard) {
                        selectedCard.remove();
                    }
                    
                    // Update the draft picks table
                    const draftPicksTable = document.getElementById('draft-picks');
                    const currentPickRow = draftPicksTable.querySelector(`tr:nth-child(${selectedPickNumber})`);
                    if (currentPickRow) {
                        currentPickRow.classList.remove('current-pick');
                        currentPickRow.classList.add('completed-pick');
                        
                        // Update the player cell
                        const playerCell = currentPickRow.querySelector('td:nth-child(3)');
                        if (playerCell) {
                            playerCell.innerHTML = document.getElementById('selected-player-name').textContent;
                        }
                    }
                    
                    if (data.status === 'draft completed') {
                        alert('Draft completed successfully!');
                        window.location.href = `/drafts/${draftId}/results/`;
                    } else {
                        // Move to next pick
                        const nextPickRow = draftPicksTable.querySelector(`tr:nth-child(${selectedPickNumber + 1})`);
                        if (nextPickRow) {
                            nextPickRow.classList.add('current-pick');
                        }
                        window.location.reload();
                    }
                } else {
                    alert('Error: ' + (data.message || 'Failed to add pick'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while making the pick');
            }
        });
        
        // Player search functionality
        document.getElementById('player-search').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            document.querySelectorAll('.player-card').forEach(card => {
                const playerText = card.textContent.toLowerCase();
                card.style.display = playerText.includes(searchTerm) ? 'block' : 'none';
            });
        });
    </script>
</body>
</html>